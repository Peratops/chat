<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Chat Pro</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’¬</text></svg>">
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts for a nicer look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom scrollbar for a better look in dark mode */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .sidebar { transition: transform 0.3s ease-in-out; }
        
        /* Notification popup animation */
        .notification-popup {
            animation: slideIn 0.5s ease-out forwards, fadeOut 0.5s ease-in 4.5s forwards;
        }
        @keyframes slideIn {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    </style>
</head>
<body class="bg-gray-900 overflow-hidden">
    <div id="root"></div>

    <!-- React Libraries -->
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    
    <!-- Babel to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, setDoc, query, updateDoc, where, getDocs, arrayUnion, getDoc, writeBatch, deleteDoc, limit, orderBy, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Make Firebase services available globally for the React script
        window.firebaseServices = {
            initializeApp,
            getAuth, signInAnonymously, onAuthStateChanged,
            getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, setDoc, query, updateDoc, where, getDocs, arrayUnion, getDoc, writeBatch, deleteDoc, limit, orderBy, arrayRemove,
            getStorage, ref, uploadBytes, getDownloadURL
        };
    </script>

    <!-- React Application Code -->
    <script type="text/babel" data-presets="react">
        const { useState, useEffect, useRef } = React;
        
        // --- Firebase Configuration ---
        // IMPORTANT: This configuration is for demonstration. 
        // In a real application, you should secure your keys and configure security rules.
        const firebaseConfig = {
            apiKey: "AIzaSyCcqfbDluQqNBDCElYzVOg3pBV5bG46Sjc",
            authDomain: "chat-39642.firebaseapp.com",
            databaseURL: "https://chat-39642-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "chat-39642",
            storageBucket: "chat-39642.firebasestorage.app",
            messagingSenderId: "593980460968",
            appId: "1:593980460968:web:7bdcd3f9ae9c1cb013179d",
            measurementId: "G-DB1WNLYV81"
        };

        const appId = 'company-chat-v1';

        function App() {
            const [services, setServices] = useState(null);
            const [user, setUser] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [error, setError] = useState(null);

            useEffect(() => {
                let servicesInstance = null;
                
                try {
                    if (window.firebaseServices) {
                        const s = window.firebaseServices;
                        const app = s.initializeApp(firebaseConfig);
                        const auth = s.getAuth(app);
                        const db = s.getFirestore(app);
                        const storage = s.getStorage(app);
                        servicesInstance = { app, auth, db, storage, ...s };
                        setServices(servicesInstance);
                    } else {
                        setError("Firebase scripts did not load.");
                        return;
                    }
                } catch(e) {
                    console.error("Firebase Init Error:", e);
                    setError("Could not initialize Firebase. Please check your configuration.");
                    return;
                }

                // Listen for authentication state changes
                const authUnsubscribe = servicesInstance.onAuthStateChanged(servicesInstance.auth, async (authUser) => {
                    if (authUser) {
                        const userDocRef = servicesInstance.doc(servicesInstance.db, `artifacts/${appId}/public/data/users/${authUser.uid}`);
                        
                        // Listen for user profile changes in real-time
                        const userProfileUnsubscribe = servicesInstance.onSnapshot(userDocRef, (userDoc) => {
                            if (userDoc.exists()) {
                                setUser({ ...authUser, ...userDoc.data() });
                            } else {
                                // Create a new user profile if it doesn't exist
                                servicesInstance.setDoc(userDocRef, {
                                    uid: authUser.uid,
                                    displayName: `User-${authUser.uid.slice(-6)}`,
                                    photoURL: '',
                                    lastSeen: servicesInstance.serverTimestamp(),
                                    friends: [],
                                });
                            }
                            setIsAuthReady(true);
                        });
                        
                        return () => userProfileUnsubscribe();
                    } else {
                        // Sign in the user anonymously if not authenticated
                        servicesInstance.signInAnonymously(servicesInstance.auth).catch(authError => {
                             console.error("Anonymous Sign-In Error: ", authError);
                             setError("Could not authenticate with the server.");
                        });
                    }
                });

                return () => authUnsubscribe();

            }, []);

            if (error) return <ErrorMessage message={error} />;
            if (!isAuthReady || !user || !services) return <LoadingScreen />;

            return <ChatLayout user={user} services={services} />;
        }
        
        function LoadingScreen() {
            return (
                <div className="flex items-center justify-center h-screen bg-gray-900 text-white">
                    <div className="text-center">
                        <svg className="animate-spin h-10 w-10 text-purple-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <p className="text-xl">Connecting to Secure Chat...</p>
                    </div>
                </div>
            );
        }

        function ErrorMessage({ message }) {
            return (
                <div className="flex items-center justify-center h-screen bg-gray-900 text-white">
                    <div className="text-center p-8 bg-gray-800 rounded-lg shadow-lg max-w-md">
                        <h2 className="text-2xl font-bold text-red-500 mb-4">Connection Failed</h2>
                        <p className="text-gray-300">{message}</p>
                    </div>
                </div>
            );
        }

        function ChatLayout({ user, services }) {
            const [isSidebarOpen, setIsSidebarOpen] = useState(window.innerWidth >= 768);
            const [activeRoom, setActiveRoom] = useState(null);
            const [notification, setNotification] = useState(null);

            // Adjust sidebar visibility on window resize
            useEffect(() => {
                const handleResize = () => {
                    if (window.innerWidth >= 768) {
                        setIsSidebarOpen(true);
                    } else {
                        setIsSidebarOpen(false);
                    }
                };
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            // Handle joining rooms via shared links
            useEffect(() => {
                const handleHashChange = async () => {
                    if (window.location.hash.startsWith('#room=')) {
                        const roomId = window.location.hash.substring(6);
                        if (roomId) {
                            const roomRef = services.doc(services.db, `artifacts/${appId}/public/data/rooms`, roomId);
                            const docSnap = await services.getDoc(roomRef);

                            if (docSnap.exists()) {
                                // Automatically add user to the room when joining via link
                                await services.updateDoc(roomRef, {
                                    members: services.arrayUnion(user.uid)
                                });
                                setActiveRoom({ id: docSnap.id, ...docSnap.data() });
                                
                                // Clean up the URL
                                window.history.pushState("", document.title, window.location.pathname + window.location.search);
                            } else {
                                alert("The room from the link could not be found.");
                            }
                        }
                    }
                };
                handleHashChange();
            }, [user, services]);


            return (
                <div className="flex h-screen antialiased text-gray-200 bg-gray-900 relative">
                    {notification && <NotificationPopup notification={notification} setNotification={setNotification} setActiveRoom={setActiveRoom} />}
                    <Sidebar 
                        user={user} 
                        services={services} 
                        isOpen={isSidebarOpen} 
                        setIsOpen={setIsSidebarOpen} 
                        setActiveRoom={setActiveRoom}
                        activeRoomId={activeRoom?.id}
                        setNotification={setNotification}
                    />
                    <MainChatArea 
                        user={user} 
                        services={services} 
                        activeRoom={activeRoom}
                        setActiveRoom={setActiveRoom}
                        isSidebarOpen={isSidebarOpen}
                        setIsSidebarOpen={setIsSidebarOpen}
                    />
                </div>
            );
        }

        function Sidebar({ user, services, isOpen, setIsOpen, setActiveRoom, activeRoomId, setNotification }) {
            const [rooms, setRooms] = useState([]);
            const [friends, setFriends] = useState([]);
            const [friendRequests, setFriendRequests] = useState([]);
            const [showCreateRoomModal, setShowCreateRoomModal] = useState(false);
            const [showJoinRoomModal, setShowJoinRoomModal] = useState(false);
            const [showAddFriendModal, setShowAddFriendModal] = useState(false);
            const [showProfileModal, setShowProfileModal] = useState(false);
            
            const dmRooms = rooms.filter(r => r.isDM);

            // Notification listener for new DM messages
            useEffect(() => {
                const unsubscribers = dmRooms.map(room => {
                    if (room.id === activeRoomId) return null; // Don't notify for active room

                    const messagesPath = `artifacts/${appId}/public/data/rooms/${room.id}/messages`;
                    const q = services.query(services.collection(services.db, messagesPath), services.orderBy('createdAt', 'desc'), services.limit(1));
                    
                    return services.onSnapshot(q, (snapshot) => {
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === 'added') {
                                const message = change.doc.data();
                                if (message.uid !== user.uid) { 
                                    // Only show notification for recent messages
                                    const timeSince = Date.now() - (message.createdAt?.toMillis() || 0);
                                    if(timeSince < 5000) { 
                                         setNotification({
                                            from: message.displayName,
                                            text: message.text,
                                            photoURL: message.photoURL,
                                            room: room
                                        });
                                    }
                                }
                            }
                        });
                    });
                });

                return () => unsubscribers.forEach(unsub => unsub && unsub());

            }, [dmRooms, activeRoomId, user.uid]);

            // Listener for user's rooms
            useEffect(() => {
                const roomsPath = `artifacts/${appId}/public/data/rooms`;
                const q = services.query(services.collection(services.db, roomsPath), services.where('members', 'array-contains', user.uid));
                const unsubscribe = services.onSnapshot(q, (snapshot) => {
                    setRooms(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return unsubscribe;
            }, [user.uid]);
            
            // Listener for user's friends list
            useEffect(() => {
                 if (!user.friends || user.friends.length === 0) {
                     setFriends([]);
                     return;
                 };
                const usersPath = `artifacts/${appId}/public/data/users`;
                const q = services.query(services.collection(services.db, usersPath), services.where('uid', 'in', user.friends));
                const unsubscribe = services.onSnapshot(q, (snapshot) => {
                    setFriends(snapshot.docs.map(d => d.data()));
                });
                return unsubscribe;
            }, [user.friends]);
            
            // Listener for friend requests
            useEffect(() => {
                const requestsPath = `artifacts/${appId}/public/data/users/${user.uid}/friendRequests`;
                const q = services.query(services.collection(services.db, requestsPath), services.where('status', '==', 'pending'));
                const unsubscribe = services.onSnapshot(q, (snapshot) => {
                    setFriendRequests(snapshot.docs.map(d => ({id: d.id, ...d.data()})));
                });
                return unsubscribe;
            }, [user.uid]);

            const groupChats = rooms.filter(r => !r.isDM);

            const handleRoomSelect = (room) => {
                setActiveRoom(room);
                if(window.innerWidth < 768) setIsOpen(false); // Close sidebar on selection on mobile
            }
            
            return (
                <React.Fragment>
                    {isOpen && <div onClick={() => setIsOpen(false)} className="fixed inset-0 bg-black/50 z-20 md:hidden"></div>}
                    <aside className={`sidebar fixed top-0 left-0 h-full w-64 bg-gray-900 border-r border-gray-700 flex-shrink-0 z-30 flex flex-col transform ${isOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0`}>
                        <div className="flex-shrink-0 px-4 py-3 border-b border-gray-700 flex justify-between items-center">
                             <div>
                                <h1 className="text-xl font-bold text-white">Chat Pro</h1>
                                <p className="text-xs text-gray-400 mt-1 truncate" title={user.uid}>ID: {user.uid}</p>
                             </div>
                             <button onClick={() => setIsOpen(false)} className="p-1 text-gray-400 hover:text-white md:hidden">
                                 <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                             </button>
                        </div>

                        <div className="flex-grow p-4 overflow-y-auto">
                            {friendRequests.length > 0 && <Notifications requests={friendRequests} user={user} services={services} />}
                            <RoomList title="Direct Messages" rooms={dmRooms} onSelect={handleRoomSelect} activeRoomId={activeRoomId} user={user} setActiveRoom={setActiveRoom} services={services} />
                            <RoomList title="Group Chats" rooms={groupChats} onSelect={handleRoomSelect} activeRoomId={activeRoomId} user={user} setActiveRoom={setActiveRoom} services={services} />
                            <FriendList friends={friends} user={user} services={services} setActiveRoom={setActiveRoom} setIsSidebarOpen={setIsOpen} />
                        </div>

                        <div className="flex-shrink-0 p-2 border-t border-gray-700">
                            <button onClick={() => setShowCreateRoomModal(true)} className="w-full text-left text-sm p-2 rounded-md hover:bg-gray-700">Create Group</button>
                            <button onClick={() => setShowJoinRoomModal(true)} className="w-full text-left text-sm p-2 rounded-md hover:bg-gray-700">Join Group</button>
                            <button onClick={() => setShowAddFriendModal(true)} className="w-full text-left text-sm p-2 rounded-md hover:bg-gray-700">Add Friend</button>
                            <button onClick={() => setShowProfileModal(true)} className="w-full text-left text-sm p-2 rounded-md hover:bg-gray-700">Edit Profile</button>
                        </div>
                        
                        {showCreateRoomModal && <CreateRoomModal user={user} services={services} closeModal={() => setShowCreateRoomModal(false)} />}
                        {showJoinRoomModal && <JoinRoomModal user={user} services={services} closeModal={() => setShowJoinRoomModal(false)} />}
                        {showAddFriendModal && <AddFriendModal user={user} services={services} closeModal={() => setShowAddFriendModal(false)} />}
                        {showProfileModal && <ProfileModal user={user} services={services} closeModal={() => setShowProfileModal(false)} />}
                    </aside>
                </React.Fragment>
            );
        }
        
        function NotificationPopup({ notification, setNotification, setActiveRoom }) {
            const { from, text, photoURL, room } = notification;

            useEffect(() => {
                const timer = setTimeout(() => {
                    setNotification(null);
                }, 5000);
                return () => clearTimeout(timer);
            }, [notification]);

            const handleClick = () => {
                setActiveRoom(room);
                setNotification(null);
            };

            return (
                <div 
                    className="notification-popup fixed top-5 right-5 max-w-sm w-full bg-gray-800 shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden z-50 cursor-pointer"
                    onClick={handleClick}
                >
                    <div className="p-4">
                        <div className="flex items-start">
                            <div className="flex-shrink-0">
                                <img className="h-10 w-10 rounded-full" src={photoURL || `https://placehold.co/40x40/374151/E5E7EB?text=${from[0]}`} alt="" />
                            </div>
                            <div className="ml-3 w-0 flex-1 pt-0.5">
                                <p className="text-sm font-medium text-white">{from}</p>
                                <p className="mt-1 text-sm text-gray-400 truncate">{text}</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function Notifications({requests, user, services}) {
            const handleRequest = async (requestId, fromId, accept = false) => {
                const batch = services.writeBatch(services.db);
                const requestRef = services.doc(services.db, `artifacts/${appId}/public/data/users/${user.uid}/friendRequests`, requestId);

                if (accept) {
                    const userRef = services.doc(services.db, `artifacts/${appId}/public/data/users`, user.uid);
                    const friendRef = services.doc(services.db, `artifacts/${appId}/public/data/users`, fromId);
                    
                    batch.update(userRef, { friends: services.arrayUnion(fromId) });
                    batch.update(friendRef, { friends: services.arrayUnion(user.uid) });
                }
                batch.delete(requestRef);
                await batch.commit();
            };

            return (
                <div className="mb-4">
                    <h2 className="text-sm font-semibold text-gray-400 mb-2 px-2">Friend Requests</h2>
                    <ul>
                        {requests.map(req => (
                            <li key={req.id} className="p-2 rounded-md bg-gray-800 mb-2">
                                <p className="text-sm">{req.displayName} wants to be your friend.</p>
                                <div className="flex justify-end space-x-2 mt-2">
                                    <button onClick={() => handleRequest(req.id, req.from, true)} className="text-xs bg-green-600 hover:bg-green-700 px-2 py-1 rounded">Accept</button>
                                    <button onClick={() => handleRequest(req.id, req.from, false)} className="text-xs bg-red-600 hover:bg-red-700 px-2 py-1 rounded">Decline</button>
                                </div>
                            </li>
                        ))}
                    </ul>
                </div>
            )
        }

        function RoomList({ title, rooms, onSelect, activeRoomId, user, services, setActiveRoom }) {
            const [contextMenu, setContextMenu] = useState({visible: false, x: 0, y: 0, room: null});

            const getDmName = (room) => {
                if (!room.isDM || !room.members || !user) return room.name;
                const otherUserId = room.members.find(uid => uid !== user.uid);
                return room.memberDetails?.[otherUserId]?.displayName || room.name;
            }

            const handleRightClick = (e, room) => {
                e.preventDefault();
                setContextMenu({ visible: true, x: e.clientX, y: e.clientY, room });
            }

            const closeContextMenu = () => setContextMenu({visible: false, x:0, y:0, room: null});
            
            useEffect(() => {
                document.addEventListener('click', closeContextMenu);
                return () => document.removeEventListener('click', closeContextMenu);
            }, []);

            const handleLeaveRoom = async (room) => {
                closeContextMenu();
                if (room.isDM) return; // Should not be callable, but as a safeguard.
                
                const roomRef = services.doc(services.db, `artifacts/${appId}/public/data/rooms`, room.id);
                
                // Add a system message to notify others
                const messagesPath = `artifacts/${appId}/public/data/rooms/${room.id}/messages`;
                await services.addDoc(services.collection(services.db, messagesPath), {
                    type: 'system',
                    text: `${user.displayName} has left the group.`,
                    createdAt: services.serverTimestamp(),
                    uid: 'system' // Special UID for system messages
                });

                // Remove the user from the room's members list
                await services.updateDoc(roomRef, { members: services.arrayRemove(user.uid) });
                
                setActiveRoom(null); // Deselect the room after leaving
            };

            const handleShareLink = (room) => {
                closeContextMenu();
                const baseUrl = window.location.href.split('#')[0];
                const link = `${baseUrl}#room=${room.id}`;
                navigator.clipboard.writeText(link).then(() => alert('Invite link copied to clipboard!'));
            };

            return (
                <div className="mb-4">
                    <h2 className="text-sm font-semibold text-gray-400 mb-2 px-2">{title}</h2>
                    <ul>
                        {rooms.map(room => (
                            <li key={room.id} onClick={() => onSelect(room)} onContextMenu={(e) => handleRightClick(e, room)} className={`p-2 rounded-md cursor-pointer text-sm ${activeRoomId === room.id ? 'bg-blue-900/70' : 'hover:bg-gray-700/50'}`}>
                                # {room.isDM ? getDmName(room) : room.name}
                            </li>
                        ))}
                    </ul>
                     {contextMenu.visible && (
                        <div style={{ top: contextMenu.y, left: contextMenu.x }} className="absolute bg-gray-800 border border-gray-600 rounded-md shadow-lg py-1 z-50">
                           {!contextMenu.room.isDM && <button onClick={() => handleShareLink(contextMenu.room)} className="block w-full text-left px-4 py-2 text-sm text-white hover:bg-blue-600">Share Link</button>}
                           {!contextMenu.room.isDM && <button onClick={() => handleLeaveRoom(contextMenu.room)} className="block w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-red-600 hover:text-white">Leave Group</button>}
                        </div>
                    )}
                </div>
            )
        }
        
        function FriendList({ friends, user, services, setActiveRoom, setIsSidebarOpen }) {
            const handleDirectMessage = async (friend) => {
                // Generate a consistent ID for the DM room between two users
                const dmId = [user.uid, friend.uid].sort().join('_');
                const dmRoomRef = services.doc(services.db, `artifacts/${appId}/public/data/rooms`, `dm_${dmId}`);

                const docSnap = await services.getDoc(dmRoomRef);
                if (docSnap.exists()) {
                    setActiveRoom({id: docSnap.id, ...docSnap.data()});
                } else {
                    // Create a new DM room if one doesn't exist
                    const newRoom = {
                        id: `dm_${dmId}`,
                        name: `DM with ${friend.displayName}`,
                        isDM: true,
                        type: 'private',
                        createdBy: user.uid,
                        createdAt: services.serverTimestamp(),
                        members: [user.uid, friend.uid],
                        memberDetails: {
                            [user.uid]: { displayName: user.displayName, photoURL: user.photoURL },
                            [friend.uid]: { displayName: friend.displayName, photoURL: friend.photoURL },
                        }
                    };
                    await services.setDoc(dmRoomRef, newRoom);
                    setActiveRoom(newRoom);
                }
                if(window.innerWidth < 768) setIsSidebarOpen(false);
            };

            return (
                 <div className="mb-4">
                    <h2 className="text-sm font-semibold text-gray-400 mb-2 px-2">Friends</h2>
                    <ul>
                        {friends.map(friend => (
                            <li key={friend.uid} onClick={() => handleDirectMessage(friend)} className="flex items-center p-2 rounded-md text-sm hover:bg-gray-700/50 cursor-pointer">
                                <span className="w-2 h-2 bg-green-500 rounded-full mr-3 flex-shrink-0"></span>
                                <img src={friend.photoURL || `https://placehold.co/32x32/374151/E5E7EB?text=${(friend.displayName || 'U')[0]}`} alt={friend.displayName} className="w-6 h-6 rounded-full mr-2" />
                                <span className="truncate">{friend.displayName}</span>
                            </li>
                        ))}
                    </ul>
                </div>
            )
        }

        function MainChatArea({ user, services, activeRoom, setActiveRoom, isSidebarOpen, setIsSidebarOpen }) {
            const [messages, setMessages] = useState([]);
            const [copiedId, setCopiedId] = useState(false);
            const [copiedLink, setCopiedLink] = useState(false);
            const [replyTo, setReplyTo] = useState(null); // State for the message being replied to
            const messagesEndRef = useRef(null);

            const getDmName = (room) => {
                if (!room.isDM || !room.members || !user) return room.name;
                const otherUserId = room.members.find(uid => uid !== user.uid);
                return room.memberDetails?.[otherUserId]?.displayName || room.name;
            }

            const copyToClipboard = (text, type) => {
                navigator.clipboard.writeText(text).then(() => {
                    if (type === 'id') {
                        setCopiedId(true);
                        setTimeout(() => setCopiedId(false), 2000);
                    } else if (type === 'link') {
                        setCopiedLink(true);
                        setTimeout(() => setCopiedLink(false), 2000);
                    }
                });
            };
            
            const getShareLink = () => {
                const baseUrl = window.location.href.split('#')[0];
                return `${baseUrl}#room=${activeRoom.id}`;
            };
            
            // Fetch messages for the active room
            useEffect(() => {
                if (!activeRoom) {
                    setMessages([]);
                    return;
                }
                setReplyTo(null); // Clear reply state when changing rooms
                const messagesPath = `artifacts/${appId}/public/data/rooms/${activeRoom.id}/messages`;
                const q = services.query(services.collection(services.db, messagesPath), services.orderBy('createdAt'));
                const unsubscribe = services.onSnapshot(q, (snapshot) => {
                    setMessages(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return unsubscribe;
            }, [activeRoom]);
            
            // Auto-scroll to the latest message
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages]);

            if (!activeRoom) {
                return (
                    <div className="flex-1 flex flex-col items-center justify-center text-center p-4 relative">
                        <button onClick={() => setIsSidebarOpen(true)} className="absolute top-4 left-4 z-20 p-2 bg-gray-800 rounded-md text-white hover:bg-gray-700 md:hidden">
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                        </button>
                        <div>
                            <h2 className="text-2xl font-bold">Welcome to Chat Pro</h2>
                            <p className="text-gray-400 mt-2">Select a room or a friend to start chatting.</p>
                        </div>
                    </div>
                );
            }

            return (
                <main className="flex flex-col flex-1 min-w-0">
                    {/* Sticky Header */}
                    <header className="flex-shrink-0 bg-gray-900/80 backdrop-blur-sm border-b border-gray-700 p-3 flex items-center justify-between sticky top-0 z-10">
                        <div className="flex items-center">
                            <button onClick={() => setIsSidebarOpen(true)} className="p-1 text-gray-400 hover:text-white mr-2 md:hidden">
                                 <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                             </button>
                            <h2 className="text-xl font-semibold truncate"># {activeRoom.isDM ? getDmName(activeRoom) : activeRoom.name}</h2>
                        </div>
                        {activeRoom.type === 'private' && !activeRoom.isDM && (
                            <div className="flex space-x-2">
                                <button title="Copy Room ID" onClick={() => copyToClipboard(activeRoom.id, 'id')} className="text-xs flex items-center bg-gray-700 px-2 py-1 rounded-full hover:bg-gray-600">
                                    <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                                    {copiedId ? 'Copied!' : 'Copy ID'}
                                </button>
                                <button title="Copy Invite Link" onClick={() => copyToClipboard(getShareLink(), 'link')} className="text-xs flex items-center bg-gray-700 px-2 py-1 rounded-full hover:bg-gray-600">
                                     <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899l4-4a4 4 0 000-5.656 4 4 0 00-5.656 0l-4 4"></path></svg>
                                    {copiedLink ? 'Copied!' : 'Share Link'}
                                </button>
                            </div>
                        )}
                    </header>
                    
                    <div className="flex-1 p-4 sm:p-6 overflow-y-auto">
                        {messages.map(msg => {
                           if (msg.type === 'system') {
                               return <SystemMessage key={msg.id} text={msg.text} />;
                           }
                           return <MessageBubble key={msg.id} message={msg} isOwnMessage={msg.uid === user.uid} onReply={setReplyTo} />;
                        })}
                        <div ref={messagesEndRef} />
                    </div>

                    <MessageInput user={user} services={services} activeRoom={activeRoom} replyTo={replyTo} setReplyTo={setReplyTo} />
                </main>
            );
        }
        
        function SystemMessage({ text }) {
            return (
                <div className="text-center my-2">
                    <span className="text-xs text-gray-500 bg-gray-800 px-3 py-1 rounded-full">{text}</span>
                </div>
            );
        }
        
        function MessageBubble({ message, isOwnMessage, onReply }) {
            const avatarSrc = message.photoURL || `https://placehold.co/32x32/374151/E5E7EB?text=${(message.displayName || 'U')[0]}`;
            
            return (
                <div className={`chat-message flex items-end my-2 group ${isOwnMessage ? 'justify-end' : 'justify-start'}`}>
                    <div className="flex items-center">
                        {!isOwnMessage && <img src={avatarSrc} alt={message.displayName} className="w-8 h-8 rounded-full order-1 flex-shrink-0" />}
                        <div className={`flex flex-col space-y-1 text-sm max-w-xs mx-2 ${isOwnMessage ? 'order-1 items-end' : 'order-2 items-start'}`}>
                            {!isOwnMessage && <div className="text-xs text-gray-400 mb-1 px-1">{message.displayName}</div>}
                            
                            {/* Render replied-to message block */}
                            {message.replyTo && (
                                <div className="text-xs bg-gray-800/50 border-l-2 border-purple-400 px-2 py-1 mb-1 rounded opacity-80 max-w-full">
                                    <p className="font-bold">{message.replyTo.displayName}</p>
                                    <p className="text-gray-400 truncate">{message.replyTo.text}</p>
                                </div>
                            )}

                            <div className={`px-4 py-2 rounded-lg inline-block relative ${isOwnMessage ? 'rounded-br-none bg-purple-600 text-white' : 'rounded-bl-none bg-gray-700 text-gray-200'}`}>
                                {message.text}
                            </div>
                        </div>
                    </div>
                     {/* Reply button - shows on hover */}
                    <button onClick={() => onReply(message)} className={`p-1 bg-gray-800 rounded-full text-gray-400 hover:text-white transition-opacity opacity-0 group-hover:opacity-100 ${isOwnMessage ? 'order-0 mr-2' : 'order-3 ml-2'}`}>
                        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M7.707 3.293a1 1 0 010 1.414L5.414 7H11a7 7 0 017 7v2a1 1 0 11-2 0v-2a5 5 0 00-5-5H5.414l2.293 2.293a1 1 0 11-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clipRule="evenodd"></path></svg>
                    </button>
                </div>
            );
        }
        
        function MessageInput({ user, services, activeRoom, replyTo, setReplyTo }) {
             const [newMessage, setNewMessage] = useState('');
             const handleSendMessage = async (e) => {
                e.preventDefault();
                if (newMessage.trim() === '') return;
                try {
                    const messagesPath = `artifacts/${appId}/public/data/rooms/${activeRoom.id}/messages`;
                    const messagesCollectionRef = services.collection(services.db, messagesPath);
                    
                    const messageData = {
                        text: newMessage,
                        createdAt: services.serverTimestamp(),
                        uid: user.uid,
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                    };

                    // If replying to a message, add reply info to the data
                    if (replyTo) {
                        messageData.replyTo = {
                            id: replyTo.id,
                            text: replyTo.text,
                            displayName: replyTo.displayName
                        };
                    }

                    await services.addDoc(messagesCollectionRef, messageData);
                    setNewMessage('');
                    setReplyTo(null); // Clear reply state after sending
                } catch (error) { console.error("Error sending message: ", error); }
            };
            return (
                 <div className="border-t-2 border-gray-700 px-4 pt-4 pb-4">
                    {/* Reply preview UI */}
                    {replyTo && (
                        <div className="bg-gray-700 p-2 rounded-t-md text-sm mb-2">
                             <div className="flex justify-between items-center font-bold">
                                <p>Replying to {replyTo.displayName}</p>
                                <button onClick={() => setReplyTo(null)} className="text-gray-400 hover:text-white text-lg">&times;</button>
                            </div>
                            <p className="text-gray-400 truncate mt-1">{replyTo.text}</p>
                        </div>
                    )}
                    <form onSubmit={handleSendMessage} className="relative flex">
                        <input type="text" value={newMessage} onChange={(e) => setNewMessage(e.target.value)} placeholder={`Message #${activeRoom.name}`} className="w-full focus:outline-none focus:placeholder-gray-400 text-gray-200 placeholder-gray-500 pl-4 pr-16 bg-gray-800 rounded-md py-3 border border-gray-600 focus:border-purple-500"/>
                        <div className="absolute right-0 items-center inset-y-0 flex">
                            <button type="submit" className="inline-flex items-center justify-center rounded-lg px-3 py-2 transition duration-500 ease-in-out text-white bg-purple-600 hover:bg-purple-700 focus:outline-none mr-2">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className="h-6 w-6 transform rotate-90">
                                    <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path>
                                </svg>
                            </button>
                        </div>
                    </form>
                </div>
            );
        }

        function CreateRoomModal({ user, services, closeModal }) {
            const [roomName, setRoomName] = useState('');
            const [error, setError] = useState('');
            const handleCreateRoom = async (e) => {
                e.preventDefault();
                if (roomName.trim().length < 3) {
                    setError('Room name must be at least 3 characters.');
                    return;
                }
                try {
                    const roomsPath = `artifacts/${appId}/public/data/rooms`;
                    const newRoomRef = services.doc(services.collection(services.db, roomsPath));
                    await services.setDoc(newRoomRef, {
                        id: newRoomRef.id,
                        name: roomName.trim(),
                        type: 'private',
                        isDM: false,
                        createdBy: user.uid,
                        createdAt: services.serverTimestamp(),
                        members: [user.uid]
                    });
                    closeModal();
                } catch (err) {
                    console.error("Error creating room:", err);
                    setError("Failed to create room.");
                }
            };
            return (
                <Modal title="Create a Group Chat" closeModal={closeModal}>
                    <form onSubmit={handleCreateRoom}>
                        <div className="mb-4">
                            <label htmlFor="roomName" className="block text-gray-400 text-sm font-bold mb-2">Group Name</label>
                            <input id="roomName" type="text" value={roomName} onChange={(e) => setRoomName(e.target.value)} className="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:border-purple-500" />
                        </div>
                        {error && <p className="text-red-400 text-sm text-center mb-4">{error}</p>}
                        <div className="flex justify-end space-x-4">
                            <button type="button" onClick={closeModal} className="text-gray-400 hover:text-white">Cancel</button>
                            <button type="submit" className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md">Create</button>
                        </div>
                    </form>
                </Modal>
            );
        }

        function JoinRoomModal({ user, services, closeModal }) {
             const [roomId, setRoomId] = useState('');
             const [error, setError] = useState('');
             const [success, setSuccess] = useState('');
            
            const handleJoin = async (e) => {
                e.preventDefault();
                setError('');
                setSuccess('');
                const trimmedRoomId = roomId.trim();
                if (trimmedRoomId === '') return;
                const roomRef = services.doc(services.db, `artifacts/${appId}/public/data/rooms`, trimmedRoomId);
                try {
                   const docSnap = await services.getDoc(roomRef);
                   if (docSnap.exists()) {
                       await services.updateDoc(roomRef, { members: services.arrayUnion(user.uid) });
                       setSuccess(`Successfully joined group!`);
                       setTimeout(closeModal, 1500);
                   } else {
                       setError("No group found with this ID. Please check the ID and try again.");
                   }
                } catch(err) {
                    console.error("Error joining room: ", err);
                    setError("An error occurred while trying to join the group.");
                }
            }
             return (
                 <Modal title="Join a Group Chat" closeModal={closeModal}>
                     <form onSubmit={handleJoin}>
                        <label htmlFor="roomId" className="block text-gray-400 text-sm font-bold mb-2">Enter Group ID</label>
                        <input id="roomId" type="text" value={roomId} onChange={(e) => setRoomId(e.target.value)} className="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:border-purple-500" />
                        {error && <p className="text-red-400 text-sm text-center my-4">{error}</p>}
                        {success && <p className="text-green-400 text-sm text-center my-4">{success}</p>}
                        <div className="flex justify-end space-x-4 mt-6">
                            <button type="button" onClick={closeModal} className="text-gray-400 hover:text-white">Cancel</button>
                            <button type="submit" className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md">Join</button>
                        </div>
                     </form>
                 </Modal>
            )
        }

        function AddFriendModal({ user, services, closeModal }) {
             const [friendId, setFriendId] = useState('');
             const [error, setError] = useState('');
             const [success, setSuccess] = useState('');
            
            const handleAddFriend = async (e) => {
                e.preventDefault();
                setError('');
                setSuccess('');
                const id = friendId.trim();
                if (id === '' || id === user.uid) {
                    setError("Please enter a valid User ID.");
                    return;
                }
                
                const friendDocRef = services.doc(services.db, `artifacts/${appId}/public/data/users`, id);
                const friendSnap = await services.getDoc(friendDocRef);
                
                if (!friendSnap.exists()) {
                    setError("User not found.");
                    return;
                }

                const requestRef = services.doc(services.db, `artifacts/${appId}/public/data/users/${id}/friendRequests`, user.uid);
                await services.setDoc(requestRef, {
                    from: user.uid,
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    status: 'pending',
                    createdAt: services.serverTimestamp()
                });
                
                setSuccess("Friend request sent!");
                setTimeout(closeModal, 1500);
            }

             return (
                 <Modal title="Add a Friend" closeModal={closeModal}>
                     <p className="text-sm text-gray-400 mb-4">Enter your friend's unique User ID to send a request.</p>
                     <form onSubmit={handleAddFriend}>
                        <label htmlFor="friendId" className="block text-gray-400 text-sm font-bold mb-2">User ID</label>
                        <input id="friendId" type="text" value={friendId} onChange={(e) => setFriendId(e.target.value)} className="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:border-purple-500" />
                        {error && <p className="text-red-400 text-sm text-center my-4">{error}</p>}
                        {success && <p className="text-green-400 text-sm text-center my-4">{success}</p>}
                        <div className="flex justify-end space-x-4 mt-6">
                            <button type="button" onClick={closeModal} className="text-gray-400 hover:text-white">Cancel</button>
                            <button type="submit" className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md">Send Request</button>
                        </div>
                     </form>
                 </Modal>
            )
        }

        function ProfileModal({ user, services, closeModal }) {
            const { db, storage } = services;
            const [displayName, setDisplayName] = useState(user.displayName || '');
            const [isUploading, setIsUploading] = useState(false);
            const [error, setError] = useState('');
            const profilePicInputRef = useRef(null);

            const handleUpdateProfile = async (e) => {
                e.preventDefault();
                if(!displayName.trim()) { setError('Display name cannot be empty.'); return; }
                setError('');
                const userDocRef = services.doc(db, `artifacts/${appId}/public/data/users/${user.uid}`);
                try {
                    await services.updateDoc(userDocRef, { displayName });
                    closeModal();
                } catch(err) {
                    console.error("Error updating display name:", err);
                    setError('Failed to update profile.');
                }
            };
            
            const handleProfilePicChange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (!file.type.startsWith('image/')) { setError('Please select an image file.'); return; }
                if (file.size > 5 * 1024 * 1024) { setError('File size should not exceed 5MB.'); return; }
                
                setError('');
                setIsUploading(true);
                const storageRef = services.ref(storage, `profile_pics/${user.uid}`);
                
                try {
                    await services.uploadBytes(storageRef, file);
                    const downloadURL = await services.getDownloadURL(storageRef);
                    const userDocRef = services.doc(db, `artifacts/${appId}/public/data/users/${user.uid}`);
                    await services.updateDoc(userDocRef, { photoURL: downloadURL });
                } catch(err) {
                    console.error("Error uploading profile picture:", err);
                    setError('Failed to upload picture.');
                } finally {
                    setIsUploading(false);
                }
            };

            return (
                <Modal title="Edit Profile" closeModal={closeModal}>
                    <div className="flex flex-col items-center mb-6">
                         <img src={user.photoURL || `https://placehold.co/96x96/374151/E5E7EB?text=${(displayName || 'U')[0]}`} alt="Profile" className="w-24 h-24 rounded-full mb-4 object-cover" />
                         <input type="file" accept="image/*" ref={profilePicInputRef} onChange={handleProfilePicChange} className="hidden" />
                         <button onClick={() => profilePicInputRef.current.click()} disabled={isUploading} className="bg-gray-700 hover:bg-gray-600 text-white text-sm py-1 px-3 rounded-md disabled:opacity-50">
                             {isUploading ? 'Uploading...' : 'Change Picture'}
                         </button>
                    </div>
                    {error && <p className="text-red-400 text-sm text-center mb-4">{error}</p>}
                    <form onSubmit={handleUpdateProfile}>
                        <div className="mb-4">
                            <label htmlFor="displayName" className="block text-gray-400 text-sm font-bold mb-2">Display Name</label>
                            <input
                                id="displayName"
                                type="text"
                                value={displayName}
                                onChange={(e) => setDisplayName(e.target.value)}
                                className="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:border-purple-500"
                            />
                        </div>
                        <div className="flex items-center justify-end space-x-4">
                             <button type="button" onClick={closeModal} className="text-gray-400 hover:text-white">Cancel</button>
                             <button type="submit" className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none">Save</button>
                        </div>
                    </form>
                </Modal>
            );
        }

        function Modal({ title, children, closeModal }) {
             return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="bg-gray-800 rounded-lg p-8 w-full max-w-md mx-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-white">{title}</h2>
                            <button onClick={closeModal} className="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                        </div>
                        {children}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>

</body>
</html>
